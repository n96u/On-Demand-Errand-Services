{% extends 'base.html' %}

{% block title %}Create Errand - GrabItDone{% endblock %}
{% block header_title %}Create New Errand{% endblock %}

{% block content %}
{# === FALLBACK DEFAULTS (Used if dynamic config is empty) === #}
{% set default_prices = {
    'Food Delivery': system_config.foodDeliveryFee|default(100)|float,
    'Grocery Shopping': system_config.groceryFee|default(150)|float,
    'Package Delivery': system_config.packageFee|default(80)|float,
    'Document Processing': system_config.documentFee|default(120)|float,
    'Bill Payment': system_config.otherErrandFee|default(100)|float
} %}

<style>
    /* === STYLES === */
    .auth-container { max-width: 800px; margin: 0 auto; }
    .auth-card { background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border); overflow: hidden; }
    .auth-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; }
    .auth-header h2 { margin: 0; font-size: 1.5rem; }
    .auth-form { padding: 2rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); }
    .form-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 0.9rem; background: var(--surface); color: var(--text-primary); }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(201, 181, 156, 0.1); }
    textarea.form-control { resize: vertical; min-height: 100px; }
    .config-description { font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem; }
    
    /* Alerts */
    .verification-alert { animation: fadeIn 0.5s ease-in; display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; margin-bottom: 2rem; background: var(--warning-light); border: 1px solid var(--warning); border-radius: var(--radius); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Disabled States */
    .form-control:disabled, select:disabled, textarea:disabled { background-color: var(--background) !important; cursor: not-allowed !important; opacity: 0.6 !important; }
    .btn:disabled { background-color: var(--text-muted) !important; cursor: not-allowed !important; }
    
    /* Pricing Box */
    .pricing-summary { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin: 1.5rem 0; display: none; border-left: 4px solid var(--primary); }
    .pricing-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
    .pricing-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
    .pricing-item:last-child { border-bottom: none; }
    .pricing-label { color: var(--text-secondary); font-size: 0.9rem; flex: 2; }
    .pricing-value { font-weight: 600; color: var(--text-primary); flex: 1; text-align: right; }
    .pricing-total { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; margin-top: 0.5rem; border-top: 2px solid var(--primary); font-size: 1.1rem; font-weight: 700; }
    .total-label { color: var(--text-primary); }
    .total-value { color: var(--primary); font-size: 1.3rem; }
    .fee-breakdown { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: normal; }
    
    .form-actions { display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .btn-block { width: 100%; }
    .dynamic-field { animation: fadeIn 0.3s ease-out; }
    
    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .form-actions { flex-direction: column; } .auth-form { padding: 1.5rem; } .verification-alert { flex-direction: column; text-align: center; gap: 0.5rem; } }
</style>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2>Create New Errand</h2>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">
                Fill in the details below to create your errand request
            </p>
        </div>
        
        <div class="auth-form">
            <form method="post" id="errandForm">
                {# Hidden inputs to send calculated values to backend #}
                <input type="hidden" name="calculated_base_price" id="calculatedBasePrice" value="">
                <input type="hidden" name="calculated_delivery_fee" id="calculatedDeliveryFee" value="">
                <input type="hidden" name="calculated_total" id="calculatedTotal" value="">
                <input type="hidden" name="estimated_distance" id="estimatedDistance" value="">
                
                {# === Verification Check === #}
                {% if not user.verified %}
                <div class="verification-alert">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: var(--warning);"></i>
                    <div style="flex: 1;">
                        <strong style="color: var(--warning-dark);">Account Verification Required</strong>
                        <div style="font-size: 0.9rem; margin-top: 0.25rem; color: var(--warning-dark);">
                            Verify your account to start posting errands and access all features.
                        </div>
                    </div>
                    <a href="{{ url_for('main.verification') }}" class="btn btn-warning btn-sm" style="white-space: nowrap;">
                        <i class="fas fa-shield-alt mr-1"></i> Verify Now
                    </a>
                </div>
                {% endif %}
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service Category</label>
                        <select name="category" class="form-control" id="categorySelect" required 
                                onchange="handleCategoryChange()" {% if not user.verified %}disabled{% endif %}>
                            <option value="">Select a service category</option>
                            {# Fallback loop if JS fails or JSON is empty #}
                            {% for category, price in default_prices.items() %}
                            <option value="{{ category }}" data-base-price="{{ price }}">
                                {{ category }} (Starts at ₱{{ "%.2f"|format(price) }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="config-description" id="categoryDescription">
                            Select a category to see specific forms.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Municipality / Area</label>
                        <select name="barangay" class="form-control" id="barangaySelect" required 
                                onchange="calculateTotalFee()" {% if not user.verified %}disabled{% endif %}>
                            <option value="">Select your area</option>
                            {# Fallback static list #}
                            {% for barangay in ['Lipa City', 'Sto. Tomas', 'Tanuan', 'Rosario', 'Padre Garcia'] %}
                            <option value="{{ barangay }}">{{ barangay }}</option>
                            {% endfor %}
                        </select>
                        <div class="config-description">
                            We use this to calculate base distance fees.
                        </div>
                    </div>
                </div>

                {# === DYNAMIC FORM CONTAINER === #}
                <div id="dynamicFormFields">
                    <div style="padding: 2rem; text-align: center; color: var(--text-muted); background: var(--background); border-radius: var(--radius); border: 1px dashed var(--border);">
                        <i class="fas fa-hand-pointer"></i> Please select a Service Category above to proceed.
                    </div>
                </div>

                {# === PRICING CALCULATOR === #}
                <div class="pricing-summary" id="pricingSummary">
                    <div class="pricing-header">
                        <i class="fas fa-receipt"></i>
                        Cost Breakdown
                    </div>
                    
                    <div class="pricing-item">
                        <div class="pricing-label">
                            Base Service Fee
                            <div class="fee-breakdown" id="summaryCategory"></div>
                        </div>
                        <div class="pricing-value">₱<span id="summaryBasePrice">0.00</span></div>
                    </div>
                    
                    <div class="pricing-item">
                        <div class="pricing-label">
                            Delivery Fee
                            <div class="fee-breakdown" id="summaryDeliveryBreakdown"></div>
                        </div>
                        <div class="pricing-value">₱<span id="summaryDeliveryFee">0.00</span></div>
                    </div>
                    
                    <div class="pricing-item">
                        <div class="pricing-label">
                            VAT ({{ system_config.vatRate|default('12') }}%)
                            <div class="fee-breakdown">Govt mandated tax</div>
                        </div>
                        <div class="pricing-value">₱<span id="summaryTaxAmount">0.00</span></div>
                    </div>
                    
                    <div class="pricing-total">
                        <div class="total-label">Estimated Total</div>
                        <div class="total-value">₱<span id="summaryTotalAmount">0.00</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select name="payment_method" class="form-control" required {% if not user.verified %}disabled{% endif %}>
                        <option value="">Select payment method</option>
                        <option value="cash">Cash on Delivery</option>
                        <option value="wallet">Wallet Balance (₱{{ "%.2f"|format(user.wallet_balance) }})</option>
                    </select>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="use_wallet" id="use_wallet" value="on" 
                               onchange="toggleWalletPayment()" {% if not user.verified %}disabled{% endif %}>
                        <label for="use_wallet" style="margin: 0; font-weight: 600;">Pay with wallet balance</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-block" id="submitBtn" {% if not user.verified %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i> 
                        {% if user.verified %}Create Errand{% else %}Verification Required{% endif %}
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-block">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// === 1. GET SYSTEM CONFIGURATION FROM SERVER ===
function getPricingConfig() {
    return {
        deliveryFee: {
            base: parseFloat('{{ system_config.baseDeliveryFee|default(50.00) }}'),
            perKm: parseFloat('{{ system_config.perKmRate|default(15.00) }}'),
            baseKm: parseFloat('{{ system_config.baseDistanceIncluded|default(3.0) }}')
        },
        taxRate: parseFloat('{{ system_config.vatRate|default(12.00) }}') / 100
    };
}

// === 2. DYNAMIC DROPDOWNS POPULATION ===
function populateDynamicCategories() {
    // Safely get JSON from Jinja2 context
    let rawJson = `{{ system_config.serviceCategories_json|default('[]')|safe }}`;
    try {
        const categories = JSON.parse(rawJson);
        const select = document.getElementById('categorySelect');
        
        // Only override if we actually have data
        if (categories && categories.length > 0) {
            select.innerHTML = '<option value="">Select a service category</option>';
            categories.forEach(cat => {
                if (cat.active) {
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.textContent = `${cat.name} (Start at ₱${parseFloat(cat.price).toFixed(2)})`;
                    opt.setAttribute('data-base-price', cat.price);
                    opt.setAttribute('data-description', cat.description || '');
                    select.appendChild(opt);
                }
            });
        }
    } catch (e) {
        console.warn("Could not parse dynamic categories, falling back to defaults.");
    }
}

function populateDynamicLocations() {
    let rawJson = `{{ system_config.barangayList_json|default('[]')|safe }}`;
    try {
        const locations = JSON.parse(rawJson);
        const select = document.getElementById('barangaySelect');
        
        if (locations && locations.length > 0) {
            select.innerHTML = '<option value="">Select your area</option>';
            locations.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc.name;
                opt.textContent = loc.name;
                // Store surcharge data in the option element
                opt.setAttribute('data-surcharge', loc.surcharge || 0);
                select.appendChild(opt);
            });
        }
    } catch (e) {
        console.warn("Could not parse dynamic locations.");
    }
}

// === 3. FORM UI BUILDER ===
function handleCategoryChange() {
    updateDynamicFields();
    calculateTotalFee();
}

function updateDynamicFields() {
    const categorySelect = document.getElementById('categorySelect');
    const category = categorySelect.value;
    const container = document.getElementById('dynamicFormFields');
    const isVerified = "{{ 'true' if user.verified else 'false' }}";
    const disabledAttr = (isVerified === 'false') ? 'disabled' : '';

    if (!category) {
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--text-muted); background: var(--background); border-radius: var(--radius); border: 1px dashed var(--border);">
                <i class="fas fa-hand-pointer"></i> Please select a Service Category above to proceed.
            </div>`;
        return;
    }

    // Determine field labels based on category context
    let pickupLabel = "Pickup Address";
    let pickupPlaceholder = "Enter complete address";
    let dropoffLabel = "Drop-off Address";
    let descPlaceholder = "Provide detailed description...";
    let icon = "fa-box";

    if (category.toLowerCase().includes('food')) {
        pickupLabel = "Restaurant / Stall Location";
        pickupPlaceholder = "e.g. Jollibee, Bayan Market Stall #4";
        descPlaceholder = "List your order items (e.g., 2x Burger, 1x Fries)...";
        icon = "fa-utensils";
    } else if (category.toLowerCase().includes('grocery') || category.toLowerCase().includes('shop')) {
        pickupLabel = "Store / Supermarket Name";
        pickupPlaceholder = "e.g. Puregold, SM Supermarket";
        descPlaceholder = "List items to buy, brand preferences, max budget...";
        icon = "fa-shopping-cart";
    } else if (category.toLowerCase().includes('bill')) {
        pickupLabel = "Payment Center";
        pickupPlaceholder = "e.g. Meralco, Bayad Center";
        descPlaceholder = "Account Number, Account Name, Amount to pay...";
        icon = "fa-file-invoice-dollar";
    } else if (category.toLowerCase().includes('document')) {
        pickupLabel = "Pickup Location";
        dropoffLabel = "Submission Location";
        descPlaceholder = "What documents are being processed?";
        icon = "fa-file-alt";
    }

    // Inject HTML
    container.innerHTML = `
        <div class="dynamic-field">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${pickupLabel}</label>
                    <input type="text" name="pickup_address" class="form-control" 
                           placeholder="${pickupPlaceholder}" required ${disabledAttr}>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-location-arrow" style="color:var(--accent)"></i> ${dropoffLabel}</label>
                    <input type="text" name="dropoff_address" class="form-control" 
                           placeholder="Enter complete address" required ${disabledAttr}>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fas ${icon}" style="color:var(--text-secondary)"></i> Details / Instructions</label>
                <textarea name="description" class="form-control" 
                          placeholder="${descPlaceholder}" 
                          required ${disabledAttr}></textarea>
                <div class="config-description">
                    Be specific about items, quantities, and any special instructions
                </div>
            </div>
        </div>
    `;
}

// === 4. FEE CALCULATION LOGIC ===
function calculateTotalFee() {
    const categorySelect = document.getElementById('categorySelect');
    const barangaySelect = document.getElementById('barangaySelect');
    const pricingSummary = document.getElementById('pricingSummary');
    
    if (!categorySelect.value || !barangaySelect.value) {
        pricingSummary.style.display = 'none';
        return;
    }
    
    const config = getPricingConfig();
    
    // 1. Get Base Price from Category
    const basePrice = parseFloat(categorySelect.options[categorySelect.selectedIndex].getAttribute('data-base-price')) || 0;
    
    // 2. Get Surcharge from Barangay (set in system_config)
    const remoteSurcharge = parseFloat(barangaySelect.options[barangaySelect.selectedIndex].getAttribute('data-surcharge')) || 0;
    
    // 3. Calculate Distance Fee
    // NOTE: In a real app, this would use Google Maps API. 
    // Here we simulate distance based on basic logic or randomization for demo purposes,
    // or assume a fixed average distance for the selected barangay.
    const distance = 5.0; // Default average distance
    
    let deliveryFee = config.deliveryFee.base;
    let distanceMsg = `${config.deliveryFee.baseKm}km base included`;
    
    // Add Excess Distance Fee
    if (distance > config.deliveryFee.baseKm) {
        const excess = distance - config.deliveryFee.baseKm;
        const excessFee = excess * config.deliveryFee.perKm;
        deliveryFee += excessFee;
        distanceMsg += ` + ${excess.toFixed(1)}km excess`;
    }
    
    // Add Remote Surcharge
    if (remoteSurcharge > 0) {
        deliveryFee += remoteSurcharge;
        distanceMsg += ` + Remote Area Fee`;
    }

    // 4. Calculate Totals
    const subtotal = basePrice + deliveryFee;
    const taxAmount = subtotal * config.taxRate;
    const totalAmount = subtotal + taxAmount;
    
    // 5. Update UI
    document.getElementById('summaryBasePrice').textContent = basePrice.toFixed(2);
    document.getElementById('summaryDeliveryFee').textContent = deliveryFee.toFixed(2);
    document.getElementById('summaryTaxAmount').textContent = taxAmount.toFixed(2);
    document.getElementById('summaryTotalAmount').textContent = totalAmount.toFixed(2);
    document.getElementById('summaryCategory').textContent = categorySelect.value;
    document.getElementById('summaryDeliveryBreakdown').textContent = distanceMsg;
    
    // 6. Update Hidden Inputs
    document.getElementById('calculatedBasePrice').value = basePrice.toFixed(2);
    document.getElementById('calculatedDeliveryFee').value = deliveryFee.toFixed(2);
    document.getElementById('calculatedTotal').value = totalAmount.toFixed(2);
    document.getElementById('estimatedDistance').value = distance;
    
    pricingSummary.style.display = 'block';
    toggleWalletPayment();
}

function toggleWalletPayment() {
    const useWallet = document.getElementById('use_wallet').checked;
    const totalAmount = parseFloat(document.getElementById('summaryTotalAmount').textContent) || 0;
    const walletBalance = parseFloat('{{ user.wallet_balance|default(0) }}');
    const submitBtn = document.getElementById('submitBtn');
    
    if (useWallet && totalAmount > 0) {
        if (walletBalance >= totalAmount) {
            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Pay & Create Errand';
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-warning');
            submitBtn.classList.add('btn-primary');
        } else {
            const shortage = totalAmount - walletBalance;
            submitBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Insufficient Balance (Short: ₱${shortage.toFixed(2)})`;
            submitBtn.disabled = true;
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-warning');
        }
    } else {
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Create Errand';
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }
}

// Initialize on Load
document.addEventListener('DOMContentLoaded', function() {
    populateDynamicCategories();
    populateDynamicLocations();
    
    // Check if form has values (e.g. after validation error reload)
    if(document.getElementById('categorySelect').value) {
        updateDynamicFields();
        calculateTotalFee();
    }
});
</script>
{% endblock %}