{% extends 'base.html' %}

{% block title %}System Configuration - Admin{% endblock %}
{% block header_title %}System Configuration{% endblock %}

{% block content %}
<style>
    .config-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .config-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: var(--primary-light);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    .config-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .config-card-header {
        background: var(--primary-light);
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .config-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .config-card-body {
        padding: 1.5rem;
    }

    .config-form {
        display: grid;
        gap: 1.5rem;
    }

    .config-group {
        display: grid;
        gap: 0.5rem;
    }

    .config-label {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .config-description {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
        line-height: 1.4;
    }

    .config-input, .config-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 0.9rem;
        background: var(--surface);
        color: var(--text-primary);
    }

    .config-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .currency-symbol {
        color: var(--text-muted);
        margin-right: 0.25rem;
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 1;
    }
    
    .input-wrapper {
        position: relative;
    }
    
    .input-wrapper .config-input {
        padding-left: 1.5rem;
    }

    .form-row, .form-row-3 {
        display: grid;
        gap: 1.5rem;
    }
    .form-row { grid-template-columns: 1fr 1fr; }
    .form-row-3 { grid-template-columns: 1fr 1fr 1fr; }

    .config-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Table Styles */
    .dynamic-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }
    
    .dynamic-table th {
        text-align: left;
        padding: 0.75rem;
        background: var(--background);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.85rem;
        border-bottom: 2px solid var(--border);
    }
    
    .dynamic-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }
    
    .action-btn-sm {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .btn-danger { background: #ffebee; color: #c62828; }
    
    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(0,0,0,0.1);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
        .form-row, .form-row-3 { grid-template-columns: 1fr; }
        .config-actions { flex-direction: column; }
    }
</style>

<div class="config-container">
    <div class="config-header">
        <h1 style="margin: 0; font-size: 1.8rem;">System Configuration</h1>
        <div id="saveStatus" style="display: none;">
            <span class="badge badge-success">Changes Saved!</span>
        </div>
    </div>

    <div class="config-tabs">
        <button class="tab-btn active" data-tab="pricing">Global Fees & Formula</button>
        <button class="tab-btn" data-tab="categories">Service Categories</button>
        <button class="tab-btn" data-tab="locations">Barangay Matrix</button>
        <button class="tab-btn" data-tab="test">Test Calculator</button>
    </div>

    <div class="tab-content active" id="pricing-tab">
        <div class="config-card">
            <div class="config-card-header">
                <h2 class="config-card-title">Financial Settings</h2>
            </div>
            <div class="config-card-body">
                <form class="config-form" id="pricingForm">
                    <div class="config-section">
                        <h3 class="section-title"><i class="fas fa-percentage"></i> Commission & Tax</h3>
                        <div class="form-row">
                            <div class="config-group">
                                <label class="config-label">Platform Commission (%)</label>
                                <input type="number" class="config-input" id="platformCommission" value="10.00" min="0" max="30" step="0.5">
                                <small class="config-description">Percentage taken from Runner's earnings.</small>
                            </div>
                            <div class="config-group">
                                <label class="config-label">VAT Tax Rate (%)</label>
                                <input type="number" class="config-input" id="vatRate" value="12.00" min="0" max="20" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3 class="section-title"><i class="fas fa-calculator"></i> Distance Fee Formula</h3>
                        <p class="config-description" style="margin-bottom: 1rem;">
                            The fee is calculated based on the distance between the <b>Pickup</b> and <b>Drop-off</b> barangays.
                        </p>
                        <div class="form-row-3">
                            <div class="config-group">
                                <label class="config-label">Base Fee (Flagdown)</label>
                                <div class="input-wrapper">
                                    <span class="currency-symbol">₱</span>
                                    <input type="number" class="config-input" id="baseDeliveryFee" value="50.00">
                                </div>
                            </div>
                            <div class="config-group">
                                <label class="config-label">Base km Included</label>
                                <input type="number" class="config-input" id="baseDistanceIncluded" value="3.0">
                            </div>
                            <div class="config-group">
                                <label class="config-label">Excess Rate / km</label>
                                <div class="input-wrapper">
                                    <span class="currency-symbol">₱</span>
                                    <input type="number" class="config-input" id="perKmRate" value="15.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="tab-content" id="categories-tab">
        <div class="config-card">
            <div class="config-card-header">
                <h2 class="config-card-title">Service Categories</h2>
                <button type="button" class="btn btn-sm btn-primary" onclick="addCategoryRow()">
                    <i class="fas fa-plus"></i> Add Category
                </button>
            </div>
            <div class="config-card-body">
                <table class="dynamic-table">
                    <thead>
                        <tr>
                            <th>Category Name</th>
                            <th>Description</th>
                            <th width="120">Base Price (₱)</th>
                            <th width="100">Status</th>
                            <th width="60"></th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-content" id="locations-tab">
        <div class="config-card">
            <div class="config-card-header">
                <h2 class="config-card-title">Barangay Location Database</h2>
            </div>
            <div class="config-card-body">
                
                <div class="config-section">
                    <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Area Setup</h3>
                    <p class="config-description">
                        Select your operating city. This allows the system to fetch the correct Barangays and find their GPS coordinates.
                    </p>
                    <div class="form-row-3">
                        <div class="config-group">
                            <label class="config-label">Region</label>
                            <select id="regionSelect" class="config-select" onchange="loadProvinces()">
                                <option value="">Select Region...</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">Province</label>
                            <select id="provinceSelect" class="config-select" onchange="loadCities()" disabled>
                                <option value="">Select Province...</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">City / Municipality</label>
                            <select id="citySelect" class="config-select" disabled>
                                <option value="">Select City...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="config-section" style="background: var(--background); padding: 1rem; border-radius: var(--radius);">
                    <h3 class="section-title" style="margin-top:0; font-size: 1rem;"><i class="fas fa-magic"></i> Auto-Calculation Rules</h3>
                    <div class="form-row">
                        <div class="config-group">
                            <label class="config-label">Remote Threshold (km from City Center)</label>
                            <input type="number" class="config-input" id="remoteThreshold" value="8.0" step="0.5">
                            <small class="config-description">Barangays further than this will get a surcharge.</small>
                        </div>
                        <div class="config-group">
                            <label class="config-label">Surcharge Rate (₱ per extra km)</label>
                            <div class="input-wrapper">
                                <span class="currency-symbol">₱</span>
                                <input type="number" class="config-input" id="remoteSurchargeRate" value="10.00">
                            </div>
                            <small class="config-description">Added fee for every km beyond threshold.</small>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 class="section-title" style="margin-bottom: 0;">Barangay Coordinates</h3>
                        <small class="text-muted">Used to calculate Peer-to-Peer distances</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-sm btn-accent" onclick="importBarangaysFromAPI()">
                            <i class="fas fa-cloud-download-alt"></i> Import Barangays
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" onclick="fetchAllCoordinates()">
                            <i class="fas fa-satellite-dish"></i> Fetch Coords & Calc Fees
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addBarangayRow()">
                            <i class="fas fa-plus"></i> Manual Add
                        </button>
                    </div>
                </div>
                
                <div style="max-height: 600px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius);">
                    <table class="dynamic-table" style="margin-bottom: 0;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th>Barangay Name</th>
                                <th width="150">Latitude</th>
                                <th width="150">Longitude</th>
                                <th width="150">Remote Surcharge (₱)</th>
                                <th width="60"></th>
                            </tr>
                        </thead>
                        <tbody id="barangayTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="test-tab">
        <div class="config-card">
            <div class="config-card-header">
                <h2 class="config-card-title">Delivery Fee Simulator</h2>
            </div>
            <div class="config-card-body">
                <div class="config-section">
                    <p>Test how the system calculates fees between two barangays based on your settings above.</p>
                    <div class="form-row">
                        <div class="config-group">
                            <label class="config-label">Pickup Barangay</label>
                            <select id="testPickup" class="config-select">
                                <option>Select Pickup...</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">Drop-off Barangay</label>
                            <select id="testDropoff" class="config-select">
                                <option>Select Drop-off...</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button type="button" class="btn btn-primary" onclick="simulateCalculation()">
                            Calculate Fee
                        </button>
                    </div>
                </div>
                
                <div id="simulationResult" style="background: var(--background); padding: 1.5rem; border-radius: var(--radius); display: none;">
                    <h3 style="margin-top: 0;">Calculation Result</h3>
                    <div id="simulationDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="config-actions">
        <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">Reset Defaults</button>
        <button type="button" class="btn btn-primary" onclick="saveAllSettings()">Save All Changes</button>
    </div>
</div>

<script>
// ==========================================
// 1. API INTEGRATION (PSGC & OpenStreetMap)
// ==========================================

const PSGC_API = 'https://psgc.gitlab.io/api';

document.addEventListener('DOMContentLoaded', function() {
    loadRegions();
    loadSystemConfig();
});

// Fetch Regions
function loadRegions() {
    fetch(`${PSGC_API}/regions`)
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('regionSelect');
            data.sort((a, b) => a.name.localeCompare(b.name));
            data.forEach(reg => {
                const opt = document.createElement('option');
                opt.value = reg.code;
                opt.textContent = `${reg.name} - ${reg.regionName}`;
                select.appendChild(opt);
            });
        })
        .catch(err => console.error('Error loading regions:', err));
}

// Fetch Provinces
function loadProvinces() {
    const regionCode = document.getElementById('regionSelect').value;
    const provinceSelect = document.getElementById('provinceSelect');
    const citySelect = document.getElementById('citySelect');
    
    provinceSelect.innerHTML = '<option value="">Select Province...</option>';
    citySelect.innerHTML = '<option value="">Select City...</option>';
    provinceSelect.disabled = true;
    citySelect.disabled = true;

    if (!regionCode) return;

    fetch(`${PSGC_API}/regions/${regionCode}/provinces`)
        .then(res => res.json())
        .then(data => {
            data.sort((a, b) => a.name.localeCompare(b.name));
            data.forEach(prov => {
                const opt = document.createElement('option');
                opt.value = prov.code;
                opt.textContent = prov.name;
                provinceSelect.appendChild(opt);
            });
            provinceSelect.disabled = false;
        });
}

// Fetch Cities/Municipalities
function loadCities() {
    const provinceCode = document.getElementById('provinceSelect').value;
    const citySelect = document.getElementById('citySelect');
    
    citySelect.innerHTML = '<option value="">Select City...</option>';
    citySelect.disabled = true;

    if (!provinceCode) return;

    fetch(`${PSGC_API}/provinces/${provinceCode}/cities-municipalities`)
        .then(res => res.json())
        .then(data => {
            data.sort((a, b) => a.name.localeCompare(b.name));
            data.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city.code;
                opt.textContent = city.name;
                citySelect.appendChild(opt);
            });
            citySelect.disabled = false;
        });
}

// ==========================================
// 2. LOGIC: Import & Geocoding & Calculation
// ==========================================

// Helper: Haversine Formula (Moved up for accessibility)
function calculateHaversine(lat1, lon1, lat2, lon2) {
    const R = 6371; // km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Import Barangays from selected City
function importBarangaysFromAPI() {
    const cityCode = document.getElementById('citySelect').value;
    
    if (!cityCode) {
        alert('Please select a City in the "Area Setup" section first.');
        return;
    }

    const btn = document.querySelector('button[onclick="importBarangaysFromAPI()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="spinner"></div> Fetching...';
    btn.disabled = true;

    fetch(`${PSGC_API}/cities-municipalities/${cityCode}/barangays`)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('barangayTableBody');
            const existingNames = Array.from(document.querySelectorAll('.brgy-name')).map(i => i.value);
            let addedCount = 0;
            data.sort((a, b) => a.name.localeCompare(b.name));
            
            data.forEach(brgy => {
                if(!existingNames.includes(brgy.name)) {
                    tbody.appendChild(createBarangayRow(brgy.name, '', '', '0')); // Default surcharge 0
                    addedCount++;
                }
            });
            
            alert(`Imported ${addedCount} barangays.`);
            updateTestDropdowns();
        })
        .catch(err => alert('Failed to fetch barangays.'))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// UPDATED: Fetch Coordinates AND Calculate Surcharge
async function fetchAllCoordinates() {
    const provSelect = document.getElementById('provinceSelect');
    const citySelect = document.getElementById('citySelect');
    
    if(!citySelect.value) {
        alert('Please ensure City and Province are selected to help the GPS search.');
        return;
    }

    const cityName = citySelect.options[citySelect.selectedIndex]?.text || "";
    const provinceName = provSelect.options[provSelect.selectedIndex]?.text || "";
    const context = `${cityName} ${provinceName}`;

    const rows = document.querySelectorAll('.barangay-row');
    if(rows.length === 0) return;

    if(!confirm(`This will fetch GPS coordinates for ${rows.length} barangays and calculate remote surcharges based on distance from the city center. Continue?`)) return;

    const btn = document.querySelector('button[onclick="fetchAllCoordinates()"]');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Processing...';

    try {
        // 1. First, fetch the City Center coordinates
        let cityLat, cityLng;
        const cityQuery = `${cityName}, ${provinceName}, Philippines`;
        const cityResp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityQuery)}&limit=1`);
        const cityData = await cityResp.json();

        if (cityData && cityData.length > 0) {
            cityLat = parseFloat(cityData[0].lat);
            cityLng = parseFloat(cityData[0].lon);
            console.log("City Center Found:", cityLat, cityLng);
        } else {
            alert("Could not find city center coordinates. Surcharges cannot be calculated automatically.");
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Fetch Coords & Calc Fees';
            return;
        }

        // Get Calculation Rules
        const threshold = parseFloat(document.getElementById('remoteThreshold').value) || 8;
        const rate = parseFloat(document.getElementById('remoteSurchargeRate').value) || 10;

        // 2. Loop through all barangays
        for (const row of rows) {
            const nameInput = row.querySelector('.brgy-name');
            const latInput = row.querySelector('.brgy-lat');
            const lngInput = row.querySelector('.brgy-lng');
            const surchargeInput = row.querySelector('.brgy-surcharge');
            
            // Skip if already has coordinates to save API calls, OR process anyway to recalc surcharge?
            // Let's recalc logic if lat/lng exists, or fetch if missing.
            let bLat = parseFloat(latInput.value);
            let bLng = parseFloat(lngInput.value);

            if (!latInput.value || !lngInput.value) {
                // Fetch from API
                const brgyName = nameInput.value;
                const query = `${brgyName}, ${context}, Philippines`;
                
                // Delay for rate limiting
                await new Promise(r => setTimeout(r, 1200));
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const results = await response.json();
                
                if(results && results.length > 0) {
                    bLat = parseFloat(results[0].lat);
                    bLng = parseFloat(results[0].lon);
                    
                    latInput.value = bLat.toFixed(6);
                    lngInput.value = bLng.toFixed(6);
                    latInput.style.borderColor = 'var(--success)';
                    lngInput.style.borderColor = 'var(--success)';
                } else {
                    latInput.style.borderColor = 'var(--warning)';
                    continue; // Skip calculation if no coords
                }
            }

            // 3. Calculate Distance from City Center
            const distFromCenter = calculateHaversine(cityLat, cityLng, bLat, bLng);
            
            // 4. Apply Surcharge Logic
            let surcharge = 0;
            if (distFromCenter > threshold) {
                const excessKm = distFromCenter - threshold;
                surcharge = excessKm * rate;
                // Round to nearest whole number
                surcharge = Math.round(surcharge);
            }

            surchargeInput.value = surcharge;
            if(surcharge > 0) {
                surchargeInput.style.borderColor = 'var(--primary)';
                surchargeInput.style.backgroundColor = 'var(--primary-light)';
            }
        }
        
        alert('Coordinate fetch and fee calculation complete!');

    } catch (e) {
        console.error(e);
        alert("An error occurred during processing.");
    }
    
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Fetch Coords & Calc Fees';
    updateTestDropdowns();
}

// ==========================================
// 3. SIMULATION LOGIC
// ==========================================

function updateTestDropdowns() {
    const pickups = document.getElementById('testPickup');
    const dropoffs = document.getElementById('testDropoff');
    
    // Clear
    pickups.innerHTML = '<option>Select Pickup...</option>';
    dropoffs.innerHTML = '<option>Select Drop-off...</option>';
    
    const rows = document.querySelectorAll('.barangay-row');
    rows.forEach((row, index) => {
        const name = row.querySelector('.brgy-name').value;
        const lat = row.querySelector('.brgy-lat').value;
        const lng = row.querySelector('.brgy-lng').value;
        const surcharge = row.querySelector('.brgy-surcharge').value || 0;
        
        if(name && lat && lng) {
            const val = JSON.stringify({lat, lng, name, surcharge});
            
            const opt1 = document.createElement('option');
            opt1.value = val;
            opt1.text = name;
            pickups.appendChild(opt1);
            
            const opt2 = document.createElement('option');
            opt2.value = val;
            opt2.text = name;
            dropoffs.appendChild(opt2);
        }
    });
}

function simulateCalculation() {
    const pVal = document.getElementById('testPickup').value;
    const dVal = document.getElementById('testDropoff').value;
    
    if(pVal.includes('Select') || dVal.includes('Select')) {
        alert('Please select valid locations with coordinates.');
        return;
    }
    
    const start = JSON.parse(pVal);
    const end = JSON.parse(dVal);
    
    // Get Configs
    const baseFee = parseFloat(document.getElementById('baseDeliveryFee').value) || 50;
    const baseKm = parseFloat(document.getElementById('baseDistanceIncluded').value) || 3;
    const ratePerKm = parseFloat(document.getElementById('perKmRate').value) || 15;
    
    // Haversine
    const dist = calculateHaversine(start.lat, start.lng, end.lat, end.lng);
    
    // Formula
    let deliveryFee = baseFee;
    let excessFee = 0;
    
    if(dist > baseKm) {
        excessFee = (dist - baseKm) * ratePerKm;
        deliveryFee += excessFee;
    }
    
    // Surcharges (Pickup + Dropoff remote fees)
    const pickupSurcharge = parseFloat(start.surcharge);
    const dropoffSurcharge = parseFloat(end.surcharge);
    const totalSurcharges = pickupSurcharge + dropoffSurcharge;
    const total = deliveryFee + totalSurcharges;
    
    // Display
    const resultDiv = document.getElementById('simulationResult');
    const detailsDiv = document.getElementById('simulationDetails');
    resultDiv.style.display = 'block';
    
    detailsDiv.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
                <strong>Route:</strong><br>
                ${start.name} <i class="fas fa-arrow-right"></i> ${end.name}
            </div>
            <div style="text-align:right;">
                <strong>Distance:</strong><br>
                ${dist.toFixed(2)} km
            </div>
        </div>
        <hr style="border:0; border-top:1px solid var(--border); margin: 0.5rem 0;">
        <div style="line-height: 1.6;">
            <div>Base Fee (${baseKm}km included): ₱${baseFee.toFixed(2)}</div>
            <div>Excess Distance (${Math.max(0, dist-baseKm).toFixed(2)}km × ₱${ratePerKm}): ₱${excessFee.toFixed(2)}</div>
            ${totalSurcharges > 0 ? `
                <div style="color:var(--warning-dark); margin-top:0.5rem; font-size:0.9rem;">
                    <strong>Remote Area Surcharges:</strong><br>
                    ${pickupSurcharge > 0 ? `• ${start.name}: ₱${pickupSurcharge.toFixed(2)}<br>` : ''}
                    ${dropoffSurcharge > 0 ? `• ${end.name}: ₱${dropoffSurcharge.toFixed(2)}` : ''}
                </div>
            ` : ''}
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: 0.5rem; border-top: 1px dashed var(--border); padding-top: 0.5rem;">
                Total Delivery Fee: ₱${total.toFixed(2)}
            </div>
        </div>
    `;
}

// ==========================================
// 4. ROW MANAGEMENT
// ==========================================

function createBarangayRow(name = '', lat = '', lng = '', surcharge = '0') {
    const tr = document.createElement('tr');
    tr.className = 'barangay-row';
    tr.innerHTML = `
        <td><input type="text" class="config-input brgy-name" value="${name}"></td>
        <td><input type="number" step="0.000001" class="config-input brgy-lat" value="${lat}" placeholder="Lat"></td>
        <td><input type="number" step="0.000001" class="config-input brgy-lng" value="${lng}" placeholder="Lng"></td>
        <td><input type="number" step="1" class="config-input brgy-surcharge" value="${surcharge}" placeholder="0.00"></td>
        <td><button type="button" class="action-btn-sm btn-danger" onclick="this.closest('tr').remove(); updateTestDropdowns();"><i class="fas fa-trash"></i></button></td>
    `;
    return tr;
}

function createCategoryRow(name = '', desc = '', icon = '', price = '', active = true) {
    const tr = document.createElement('tr');
    tr.className = 'category-row';
    tr.innerHTML = `
        <td>
            <input type="text" class="config-input cat-name" value="${name}" placeholder="Service Name">
            <input type="hidden" class="cat-icon" value="${icon || 'fas fa-box'}">
        </td>
        <td><input type="text" class="config-input cat-desc" value="${desc}" placeholder="Short description"></td>
        <td><div class="input-wrapper"><span class="currency-symbol">₱</span><input type="number" class="config-input cat-price" value="${price}"></div></td>
        <td>
            <select class="config-select cat-active">
                <option value="true" ${active ? 'selected' : ''}>Active</option>
                <option value="false" ${!active ? 'selected' : ''}>Inactive</option>
            </select>
        </td>
        <td><button type="button" class="action-btn-sm btn-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
    `;
    return tr;
}

function addBarangayRow() { document.getElementById('barangayTableBody').prepend(createBarangayRow()); }
function addCategoryRow() { document.getElementById('categoryTableBody').appendChild(createCategoryRow()); }

// ==========================================
// 5. DATA SAVING & LOADING
// ==========================================

function saveAllSettings() {
    const config = {};
    
    // Inputs
    document.querySelectorAll('.config-form input[id], .config-form select[id]').forEach(el => config[el.id] = el.value);
    
    // Capture the new fields even if they are outside the main form
    config['remoteThreshold'] = document.getElementById('remoteThreshold').value;
    config['remoteSurchargeRate'] = document.getElementById('remoteSurchargeRate').value;
    
    // Arrays
    config['barangayList_json'] = JSON.stringify(Array.from(document.querySelectorAll('.barangay-row')).map(row => ({
        name: row.querySelector('.brgy-name').value,
        lat: row.querySelector('.brgy-lat').value,
        lng: row.querySelector('.brgy-lng').value,
        surcharge: row.querySelector('.brgy-surcharge').value
    })));

    config['serviceCategories_json'] = JSON.stringify(Array.from(document.querySelectorAll('.category-row')).map(row => ({
        name: row.querySelector('.cat-name').value,
        description: row.querySelector('.cat-desc').value,
        icon: row.querySelector('.cat-icon').value,
        price: row.querySelector('.cat-price').value,
        active: row.querySelector('.cat-active').value === 'true'
    })));

    // Send
    const btn = document.querySelector('button[onclick="saveAllSettings()"]');
    btn.innerHTML = 'Saving...';
    btn.disabled = true;

    fetch('/api/system-config/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            document.getElementById('saveStatus').style.display = 'block';
            setTimeout(() => document.getElementById('saveStatus').style.display = 'none', 3000);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => alert('Network Error'))
    .finally(() => {
        btn.innerHTML = 'Save All Changes';
        btn.disabled = false;
    });
}

function loadSystemConfig() {
    fetch('/api/system-config/get')
    .then(r => r.json())
    .then(data => {
        if(data.success && data.config) {
            const c = data.config;
            // Simple fields
            ['platformCommission','vatRate','baseDeliveryFee','baseDistanceIncluded','perKmRate'].forEach(id => {
                if(document.getElementById(id) && c[id]) document.getElementById(id).value = c[id];
            });

            // New Remote Config fields
            if(c.remoteThreshold) document.getElementById('remoteThreshold').value = c.remoteThreshold;
            if(c.remoteSurchargeRate) document.getElementById('remoteSurchargeRate').value = c.remoteSurchargeRate;

            // Complex Tables
            const brgyList = JSON.parse(c.barangayList_json || '[]');
            const brgyBody = document.getElementById('barangayTableBody');
            brgyBody.innerHTML = '';
            brgyList.forEach(b => brgyBody.appendChild(createBarangayRow(b.name, b.lat, b.lng, b.surcharge)));

            const catList = JSON.parse(c.serviceCategories_json || '[]');
            const catBody = document.getElementById('categoryTableBody');
            catBody.innerHTML = '';
            catList.forEach(i => catBody.appendChild(createCategoryRow(i.name, i.description, i.icon, i.price, i.active)));
            
            updateTestDropdowns();
        } else {
            addBarangayRow(); addCategoryRow();
        }
    })
    .catch(e => { console.log('Load error', e); addBarangayRow(); });
}

function resetToDefaults() {
    if(confirm("Reset all settings?")) {
        document.getElementById('barangayTableBody').innerHTML = '';
        document.getElementById('categoryTableBody').innerHTML = '';
        addBarangayRow();
        addCategoryRow();
        document.getElementById('baseDeliveryFee').value = "50";
        document.getElementById('perKmRate').value = "15";
        document.getElementById('remoteThreshold').value = "8.0";
        document.getElementById('remoteSurchargeRate').value = "10.00";
    }
}

// Tab Switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
    });
});
</script>
{% endblock %}